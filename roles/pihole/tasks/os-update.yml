- name: Update apt cache
  become: true
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade packages (safe, no dist-upgrade)
  become: true
  apt:
    upgrade: yes

- name: Install unattended-upgrades (optional)
  become: true
  apt:
    name: unattended-upgrades
    state: present

- name: Autoremove unused packages
  become: true
  apt:
    autoremove: true

- name: Check if reboot required
  become: true
  stat:
    path: /var/run/reboot-required
  register: reboot_flag

- name: Reboot if required
  become: true
  reboot:
    msg: "Reboot triggered by Ansible after OS updates"
    reboot_timeout: 900
  when: reboot_flag.stat.exists
