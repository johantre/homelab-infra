## Resolve variables (single source of truth)
## 1) If env_file is given read .env (KEY=VALUE)
- name: Resolve variables from .env (properties) when provided
  no_log: true
  ansible.builtin.set_fact:
    gh_username: "{{ gh_username | default(lookup('ini', 'GH_USERNAME file=' + env_file + ' type=properties'), true) }}"
    gh_pat:       "{{ gh_pat       | default(lookup('ini', 'GH_PAT file=' + env_file + ' type=properties'), true) }}"
    cf_tunnel_token:  "{{ cf_tunnel_token  | default(lookup('ini', 'CF_TUNNEL_TOKEN file=' + env_file + ' type=properties'), true) }}"
    ha_backup_encrypt_key: "{{ ha_backup_encrypt_key | default(lookup('ini', 'HA_BACKUP_ENCRYPT_KEY file=' + env_file + ' type=properties'), true) }}"
  when: env_file is defined

## 2) No env_file given, get from OS-env
- name: Resolve variables from OS env when no env_file is provided
  no_log: true
  ansible.builtin.set_fact:
    gh_username: "{{ gh_username | default(lookup('env','GH_USERNAME'), true) }}"
    gh_pat:       "{{ gh_pat       | default(lookup('env','GH_PAT'), true) }}"
    cf_tunnel_token:  "{{ cf_tunnel_token  | default(lookup('env','CF_TUNNEL_TOKEN'), true) }}"
    ssh_priv_key_b64: "{{ ssh_priv_key_b64 | default(lookup('env','SSH_PRIV_KEY_B64'), true) }}"
    ha_backup_encrypt_key: "{{ ha_backup_encrypt_key | default(lookup('env','HA_BACKUP_ENCRYPT_KEY'), true) }}"
  when: env_file is not defined

# Loud fail – explicit & clear
- name: Assert GitHub tokens present
  no_log: true
  ansible.builtin.assert:
    that:
      - gh_username | length > 0
      - gh_pat | length > 0
    fail_msg: "❌ Missing GH_USERNAME or GH_PAT (via --extra-vars, env_file, or OS env). ❌"

- name: Assert CF_TUNNEL_TOKEN present when cloudflared is enabled
  no_log: true
  ansible.builtin.assert:
    that:
      - cf_tunnel_token | length > 0
    fail_msg: "❌ enable_cloudflared=true but CF_TUNNEL_TOKEN missing. ❌"
  when: enable_cloudflared | default(false)

- name: Assert SSH private key present when connection is local
  no_log: true
  ansible.builtin.assert:
    that:
      - ssh_priv_key_b64 | length > 0
    fail_msg: "❌ Missing SSH_PRIV_KEY_B64 for self-hosted runner deployment. ❌"
  when: ansible_connection == 'local'

- name: Assert HA_BACKUP_ENCRYPT_KEY present (always required)
  no_log: true
  ansible.builtin.assert:
    that:
      - ha_backup_encrypt_key | length > 0
    fail_msg: "❌ Missing HA_BACKUP_ENCRYPT_KEY (required for disaster recovery). ❌"

- name: Validate all critical variables are defined
  ansible.builtin.assert:
    that:
      # Core paths
      - ha_stack_dir is defined
      - ha_config_dir is defined
      - ha_native_backup_dir is defined
      - base_dir is defined
      - base_home is defined
      # Project config
      - ha_project is defined
      - ha_container_name is defined
      - ha_version is defined
      # Runtime config
      - runtime_uid is defined
      - runtime_gid is defined
      - tz is defined
      # Network config
      - ha_seedbox_network is defined
      - ha_network_mode is defined
      - ha_host_port is defined
      # Feature flags
      - enable_cloudflared is defined
      - enable_ssh_terminal is defined
      - enable_code_server is defined
      - enable_esphome is defined
      - enable_samba is defined
      - enable_argon_fan is defined
      - enable_target_passwordless_sudo is defined
      - ha_bootstrap_enable is defined
      # Service ports
      - code_server_port is defined
      - ssh_port is defined
      - esphome_port is defined
      - samba_tcp_445 is defined
      - samba_tcp_139 is defined
      # Service data dirs
      - code_server_data_dir is defined
      - ssh_data_dir is defined
      - esphome_data_dir is defined
      - service_data_dirs is defined
      # Credentials (checked above but verify here too)
      - gh_username is defined
      - gh_pat is defined
    fail_msg: |
      ❌ CRITICAL VARIABLE(S) MISSING! ❌
      
      This usually means:
      1. all.yml (group_vars) failed to load
      2. Inventory configuration issue
      3. Required environment variable not set
      
      Check:
      - Is your inventory correct? (-i inventories/ha_target_local.ini or ha_target_remote.ini)
      - Is all.yml in the right location?
      - Did you provide env_file? (-e env_file=../.env)
      
      Run with -vvv to see which variable is undefined.
    success_msg: "✅ All critical variables validated"

# One global env that can be used everywhere
- name: Build global Compose env (CF)
  no_log: true
  ansible.builtin.set_fact:
    compose_global_env: "{{ {'CF_TUNNEL_TOKEN': cf_tunnel_token} }}"
  when: (enable_cloudflared | default(false)) | bool

- name: Build global Compose env (empty when CF disabled)
  ansible.builtin.set_fact:
    compose_global_env: {}
  when: not (enable_cloudflared | default(false)) | bool
