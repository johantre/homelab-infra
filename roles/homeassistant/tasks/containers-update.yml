- name: Decide desired HA version for update (override > discovered > locked)
  ansible.builtin.set_fact:
    _desired_ha_version: >-
      {{ (ha_version_override | default('') | trim)
         if (ha_version_override | default('') | trim | length) > 0
         else (ha_version | trim) }}
  changed_when: false
  tags: [ha_update, containers_update]

- name: Update HA version lock
  ansible.builtin.copy:
    dest: "{{ ha_stack_dir }}/.ha_version.lock"
    mode: "0644"
    content: "{{ _desired_ha_version }}\n"
  tags: [ha_update, containers_update]

# Recompute effective version and re-render compose so the new tag is used
- name: Recompute ha_effective_version after lock change
  ansible.builtin.set_fact:
    ha_effective_version: "{{ _desired_ha_version }}"
  changed_when: false
  tags: [ha_update, containers_update]

- name: Re-render docker-compose with new HA tag
  ansible.builtin.template:
    src: "docker-compose.yml.j2"
    dest: "{{ ha_stack_dir }}/docker-compose.yml"
    mode: "0644"
  tags: [ha_update, containers_update]

## Single source of truth for env
- name: Bootstrap env (single source of truth)
  ansible.builtin.import_tasks: env_boot.yml
  tags: [always, containers_update]

# Pull + up with better error handling for network timeouts
- name: Docker compose pull and up
  block:
    - name: Docker compose pull (all services)
      no_log: true
      ansible.builtin.shell: |
        sg docker -c 'docker compose -p {{ ha_project | quote }} -f {{ ha_stack_dir }}/docker-compose.yml pull 2>&1'
      args:
        chdir: "{{ ha_stack_dir }}"
      environment: "{{ compose_global_env | mandatory('compose_global_env undefined ‚Äì env_boot skipped or failed') }}"
      register: ha_pull
      changed_when: (ha_pull.stdout | default('') ~ ha_pull.stderr | default('')) is search('Downloaded')
      tags: [ ha_update, containers_update ]

    - name: Docker compose up -d (all services)
      no_log: true
      ansible.builtin.shell: |
        sg docker -c 'docker compose -p {{ ha_project | quote }} -f {{ ha_stack_dir }}/docker-compose.yml up -d 2>&1'
      args:
        chdir: "{{ ha_stack_dir }}"
      environment: "{{ compose_global_env | mandatory('compose_global_env undefined ‚Äì env_boot skipped or failed') }}"
      register: ha_up
      changed_when: (ha_up.stdout | default('') ~ ha_up.stderr | default('')) is search('(?i)(recreated|recreating|created|creating|starting)')
      tags: [ha_update, containers_update]

  rescue:
    - name: Check Docker Hub connectivity
      ansible.builtin.shell: |
        curl -sS --connect-timeout 10 --max-time 15 https://registry-1.docker.io/v2/ 2>&1 || echo "DOCKER_HUB_UNREACHABLE"
      register: docker_hub_check
      changed_when: false
      failed_when: false

    - name: Report docker pull/up failure with diagnosis
      ansible.builtin.fail:
        msg: |
          ‚ùå DOCKER COMPOSE FAILED!

          {% if 'DOCKER_HUB_UNREACHABLE' in docker_hub_check.stdout or 'timeout' in (docker_hub_check.stderr | default('') | lower) %}
          üåê NETWORK TIMEOUT - Docker Hub is unreachable

          This usually means:
          ‚Ä¢ Docker Hub / GitHub infrastructure is overloaded
          ‚Ä¢ Network connectivity issues on this device
          ‚Ä¢ ISP routing problems

          ‚Üí Wait a few hours and re-run the workflow
          ‚Üí Or manually run: docker compose pull && docker compose up -d
          {% else %}
          üîç Docker Hub is reachable - check for other issues:
          ‚Ä¢ Invalid image tag?
          ‚Ä¢ Disk space issue?
          ‚Ä¢ Docker daemon problem?

          Check logs: journalctl -u docker --since "10 minutes ago"
          {% endif %}
  tags: [ha_update, containers_update]
