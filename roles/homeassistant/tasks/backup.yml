- name: Ensure backup dir exists
  ansible.builtin.file:
    path: "{{ ha_stack_dir }}/backup"
    state: directory
    mode: "0750"
  when: ha_backups_enabled | bool
  tags: [backups]

- name: Create HA config backup tarball (light)
  community.general.archive:
    path:
      - "{{ ha_config_dir }}/"
    dest: "{{ ha_stack_dir }}/backup/ha-config-{{ ansible_date_time.iso8601_basic_short }}.tar.gz"
    format: gz
    exclude_path:
      - "{{ ha_config_dir }}/.storage/backups"
      - "{{ ha_config_dir }}/deps"
  when: ha_backups_enabled | bool
  tags: [backups]