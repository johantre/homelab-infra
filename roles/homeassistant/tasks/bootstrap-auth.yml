---
- name: Wait until HA API answers
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -lc 'curl -fsS http://127.0.0.1:8123/ || exit 1'
  args:
    chdir: "{{ ha_stack_dir }}"
  register: ha_ping
  retries: 30
  delay: 2
  until: ha_ping.rc == 0
  changed_when: false

- name: Read current HA users
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -c 'HOME=/config python -m homeassistant --script auth list'
  args:
    chdir: "{{ ha_stack_dir }}"
  register: ha_auth_list
  changed_when: false

- name: Create first admin user if user store is empty
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -c 'HOME=/config python -m homeassistant --script auth add {{ ha_user_username | quote }} {{ ha_user_password | quote }}'
  args:
    chdir: "{{ ha_stack_dir }}"
  when: ha_auth_list.stdout is search('Total users:\s*0')
  no_log: true
  run_once: true