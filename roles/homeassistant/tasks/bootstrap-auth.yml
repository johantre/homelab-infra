---
# Bootstrap authentication for Home Assistant 2025.11+
# Uses Python script to properly create users with credentials

- name: Stop HA container for auth cleanup
  community.docker.docker_container:
    name: "{{ ha_container_name }}"
    state: stopped
  when: ha_bootstrap_enable | default(false)

- name: Clean up old auth data from new location
  ansible.builtin.file:
    path: "{{ ha_config_dir }}/.storage/{{ item }}"
    state: absent
  loop:
    - auth
    - auth_provider.homeassistant
    - onboarding
  when: ha_bootstrap_enable | default(false)

- name: Clean up old auth data from legacy location
  ansible.builtin.file:
    path: "{{ ha_config_dir }}/.homeassistant/.storage"
    state: absent
  when: ha_bootstrap_enable | default(false)

- name: Start HA container after cleanup
  community.docker.docker_container:
    name: "{{ ha_container_name }}"
    state: started
  when: ha_bootstrap_enable | default(false)

- name: Wait until HA API answers
  command: >
    docker exec {{ ha_container_name }}
    sh -lc 'curl -fsS http://127.0.0.1:8123/ || exit 1'
  register: ha_ping
  retries: 30
  delay: 2
  until: ha_ping.rc == 0
  changed_when: false
  when: ha_bootstrap_enable | default(false)

- name: Read current HA users
  command: >
    docker exec {{ ha_container_name }}
    sh -c 'HOME=/config python -m homeassistant --script auth list'
  register: ha_auth_list
  changed_when: false
  when: ha_bootstrap_enable | default(false)

- name: Copy user creation script to container
  command: >
    docker cp {{ role_path }}/files/create_ha_user.py {{ ha_container_name }}:/tmp/create_ha_user.py
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: true

- name: Create first admin user with Python script
  command: >
    docker exec {{ ha_container_name }}
    python3 /tmp/create_ha_user.py {{ ha_user_username | quote }} {{ ha_user_password | quote }}
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  no_log: true
  run_once: true
  register: user_creation
  changed_when: user_creation.rc == 0

- name: Show user creation result
  debug:
    msg: "{{ user_creation.stdout_lines }}"
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
    - user_creation.stdout_lines is defined

- name: Restart HA to apply all changes
  command: >
    docker restart {{ ha_container_name }}
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: true

- name: Wait for HA to come back up after restart
  command: >
    docker exec {{ ha_container_name }}
    sh -lc 'curl -fsS http://127.0.0.1:8123/ || exit 1'
  register: ha_ping_after_restart
  retries: 30
  delay: 2
  until: ha_ping_after_restart.rc == 0
  changed_when: false
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')

- name: Clean up temporary script
  command: >
    docker exec {{ ha_container_name }}
    rm -f /tmp/create_ha_user.py
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: false
  failed_when: false
