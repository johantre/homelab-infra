---
# Bootstrap authentication for Home Assistant 2025.11+
# Uses Python script to properly create users with credentials

- name: Stop HA container for auth cleanup
  ansible.builtin.shell: |
    sg docker -c 'docker stop {{ ha_container_name }}'
  when: ha_bootstrap_enable | default(false)
  register: ha_stop
  failed_when: false
  changed_when: ha_stop.rc == 0

- name: Clean up old auth data from new location
  ansible.builtin.file:
    path: "{{ ha_config_dir }}/.storage/{{ item }}"
    state: absent
  loop:
    - auth
    - auth_provider.homeassistant
    - onboarding
  when: ha_bootstrap_enable | default(false)

- name: Clean up old auth data from legacy location
  ansible.builtin.file:
    path: "{{ ha_config_dir }}/.homeassistant/.storage"
    state: absent
  when: ha_bootstrap_enable | default(false)

- name: Start HA container after cleanup
  ansible.builtin.shell: |
    sg docker -c 'docker start {{ ha_container_name }}'
  when: ha_bootstrap_enable | default(false)
  register: ha_start
  changed_when: ha_start.rc == 0


- name: Wait until HA API answers
  ansible.builtin.shell: |
    sg docker -c 'docker exec {{ ha_container_name }} sh -lc "curl -fsS http://127.0.0.1:{{ ha_host_port }}/ || exit 1"'
  register: ha_ping
  retries: 30
  delay: 2
  until: ha_ping.rc == 0
  changed_when: false
  when: ha_bootstrap_enable | default(false)

- name: Read current HA users
  ansible.builtin.shell: |
    sg docker -c 'docker exec {{ ha_container_name }} sh -c "HOME=/config python -m homeassistant --script auth list"'
  register: ha_auth_list
  changed_when: false
  when: ha_bootstrap_enable | default(false)

- name: Copy user creation script to target
  ansible.builtin.copy:
    src: create_ha_user.py
    dest: /tmp/create_ha_user.py
    mode: "0644"
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')

- name: Copy user creation script to container
  ansible.builtin.shell: |
    sg docker -c 'docker cp /tmp/create_ha_user.py {{ ha_container_name }}:/tmp/create_ha_user.py'
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: true

- name: Create first admin user with Python script
  ansible.builtin.shell: |
    sg docker -c 'docker exec {{ ha_container_name }} python3 /tmp/create_ha_user.py {{ ha_user_username | quote }} {{ ha_user_password | quote }}'
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  no_log: true
  run_once: true
  register: user_creation
  changed_when: user_creation.rc == 0

- name: Show user creation result
  debug:
    msg: "{{ user_creation.stdout_lines }}"
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
    - user_creation.stdout_lines is defined

- name: Restart HA to apply all changes
  ansible.builtin.shell: |
    sg docker -c 'docker restart {{ ha_container_name }}'
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: true

- name: Wait for HA to come back up after restart
  ansible.builtin.shell: |
    sg docker -c 'docker exec {{ ha_container_name }} sh -lc "curl -fsS http://127.0.0.1:{{ ha_host_port }}/ || exit 1"'
  register: ha_ping_after_restart
  retries: 30
  delay: 2
  until: ha_ping_after_restart.rc == 0
  changed_when: false
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')

# CRITICAL: Wait for HA to FULLY initialize ALL components
# API responding ≠ components initialized!
# Without this wait, stopping container for seedbox restore during
# component initialization causes backup integration to enter corrupt state
- name: Wait for all components to fully initialize (60s grace period)
  ansible.builtin.pause:
    seconds: 60
    prompt: |
      ⏳ Waiting 60 seconds for HA components to fully initialize...
      
      This prevents backup integration corruption when seedbox restore
      stops the container during component initialization.
      
      API ready ≠ components ready. This grace period is CRITICAL.
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')

- name: Clean up temporary script
  ansible.builtin.shell: |
    sg docker -c 'docker exec {{ ha_container_name }} rm -f /tmp/create_ha_user.py'
  when:
    - ha_bootstrap_enable | default(false)
    - ha_auth_list.stdout is search('Total users:\s*0')
  changed_when: false
  failed_when: false
