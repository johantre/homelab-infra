---
- name: Wait until HA API answers
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -lc 'curl -fsS http://127.0.0.1:8123/ || exit 1'
  register: ha_ping
  retries: 30
  delay: 2
  until: ha_ping.rc == 0
  changed_when: false

- name: Read current HA users
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -lc 'python -m homeassistant --script auth -c /config list'
  register: ha_auth_list
  changed_when: false

- name: Create first admin user if user store is empty
  command: >
    docker compose -p {{ ha_project }} -f {{ ha_stack_dir }}/docker-compose.yml exec -T {{ ha_container_name }}
    sh -lc 'python -m homeassistant --script auth -c /config
            add {{ ha_user_username | quote }} {{ ha_user_fullname | quote }} --password {{ ha_user_password | quote }} --group system-admin'
  when: ha_auth_list.stdout is search('Total users:\s*0')
  no_log: true
  run_once: true
