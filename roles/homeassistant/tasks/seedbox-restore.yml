---
# Seedbox restore - discover production HA on network and sync .storage

- name: Install seedbox discovery dependencies
  ansible.builtin.apt:
    name:
      - nmap
      - avahi-utils
    state: present
    update_cache: true
  become: true

# Block with guaranteed key cleanup
- block:
    - name: Deploy private key from GitHub Secrets (runner only)
      ansible.builtin.copy:
        content: "{{ lookup('env', 'SSH_PRIV_KEY_B64') | b64decode }}"
        dest: "{{ ansible_env.HOME }}/.ssh/id_ed25519_seedbox_priv"
        mode: '0600'
      when: ansible_connection == 'local'
      no_log: true

    - name: Configure SSH to use seedbox key (runner only)
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.ssh/config"
        line: "IdentityFile {{ ansible_env.HOME }}/.ssh/id_ed25519_seedbox_priv"
        create: yes
        mode: '0600'
      when: ansible_connection == 'local'

    - name: Copy seedbox discovery script to target
      ansible.builtin.copy:
        src: roles/homeassistant/files/find-seedbox.sh
        dest: /tmp/find-seedbox.sh
        mode: '0755'

    - name: Discover seedbox on network (exclude self)
      ansible.builtin.shell: |
        bash /tmp/find-seedbox.sh {{ ha_seedbox_network }} {{ ha_host_port }} {{ ansible_default_ipv4.address }}
      register: seedbox_discovery
      failed_when: false
      changed_when: false

    # Set flag based on discovery result
    - name: Set seedbox found flag
      ansible.builtin.set_fact:
        seedbox_found: "{{ seedbox_discovery.rc == 0 }}"

    - name: Show seedbox not found message
      ansible.builtin.debug:
        msg: "⚠️ No seedbox found on network - skipping seedbox restore"
      when: not seedbox_found

    - name: Show discovery output
      ansible.builtin.debug:
        msg: "{{ seedbox_discovery.stdout_lines }}"
      when: seedbox_found

    - name: Set seedbox IP from discovery
      ansible.builtin.set_fact:
        seedbox_ip: "{{ seedbox_discovery.stdout_lines | last }}"
      when: seedbox_found

    - name: Show discovered seedbox
      ansible.builtin.debug:
        msg: "Discovered seedbox at: {{ seedbox_ip }}"
      when: seedbox_found

    - name: Determine SSH user for seedbox
      ansible.builtin.shell: |
        for USER in ubuntu root; do
          if ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no -o BatchMode=yes $USER@{{ seedbox_ip }} "exit" 2>/dev/null; then
            echo $USER
            exit 0
          fi
        done
        exit 1
      register: seedbox_user_check
      failed_when: seedbox_user_check.rc != 0
      changed_when: false
      when: seedbox_found

    - name: Set seedbox SSH user
      ansible.builtin.set_fact:
        seedbox_user: "{{ seedbox_user_check.stdout }}"
      when: seedbox_found

    - name: Find .storage path on seedbox
      ansible.builtin.shell: |
        if ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} "test -d /root/homeassistant/.storage" 2>/dev/null; then
          echo /root/homeassistant/.storage
        elif ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} "test -d /home/homeassistant/.storage" 2>/dev/null; then
          echo /home/homeassistant/.storage
        elif ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} "test -d /config/.storage" 2>/dev/null; then
          echo /config/.storage
        elif ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} "test -d /home/{{ seedbox_user }}/homelab/target/homeassistant-ansible/config/.storage" 2>/dev/null; then
          echo /home/{{ seedbox_user }}/homelab/target/homeassistant-ansible/config/.storage
        elif ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} "test -d /home/{{ seedbox_user }}/homelab/target/homeassistant/config/.storage" 2>/dev/null; then
          echo /home/{{ seedbox_user }}/homelab/target/homeassistant/config/.storage
        else
          exit 1
        fi
      register: seedbox_storage_search
      failed_when: seedbox_storage_search.rc != 0
      changed_when: false
      when: seedbox_found

    - name: Set storage path
      ansible.builtin.set_fact:
        seedbox_storage_path: "{{ seedbox_storage_search.stdout }}"
      when: seedbox_found

    - name: Stop HA container before .storage sync
      ansible.builtin.shell: |
        sg docker -c 'docker stop {{ ha_container_name }}'
      changed_when: true
      when: seedbox_found

    - name: Ensure .storage directory exists before seedbox restore
      ansible.builtin.file:
        path: "{{ ha_config_dir }}/.storage"
        state: directory
        owner: "{{ runtime_uid }}"
        group: "{{ runtime_gid }}"
        mode: '0755'
      when: seedbox_found

    - name: ACTUAL SYNC - Transfer data from Seedbox to Target
      ansible.builtin.shell: |
        set -e
        # 1. Pak in op Seedbox -> 2. Pipe door laptop -> 3. Pak uit op Target Server
        ssh -o StrictHostKeyChecking=no {{ seedbox_user }}@{{ seedbox_ip }} \
          "tar -czf - --exclude='./hassio' --exclude='./backup' -C {{ seedbox_storage_path }} ." | \
        ssh -o StrictHostKeyChecking=no {{ ansible_user }}@{{ ansible_host }} \
          "tar -xzf - -C {{ ha_config_dir }}/.storage/"
      delegate_to: localhost
      changed_when: true
      when: seedbox_found

    - name: Surgical cleanup via local Python script
      ansible.builtin.script: "clean_ha.py {{ ha_config_dir }}"
      args:
        executable: python3
      register: python_cleanup_output
      changed_when: "'Successfully cleaned' in python_cleanup_output.stdout"
      when: seedbox_found

    - name: Show Python Cleanup Result
      ansible.builtin.debug:
        msg: "{{ python_cleanup_output.stdout_lines }}"
      when: seedbox_found

    - name: Verify .storage was synced (fail loud if empty)
      ansible.builtin.shell: |
        SIZE=$(du -sb {{ ha_config_dir }}/.storage/ | cut -f1)
        if [ "$SIZE" -lt 1000000 ]; then
          echo "ERROR: .storage sync failed - only $SIZE bytes transferred"
          exit 1
        fi
        echo "Success: $SIZE bytes in .storage"
      changed_when: false
      when: seedbox_found

    - name: Fix .storage ownership
      ansible.builtin.file:
        path: "{{ ha_config_dir }}/.storage"
        owner: "{{ runtime_uid }}"
        group: "{{ runtime_gid }}"
        recurse: yes
        state: directory
      when: seedbox_found

    - name: Start HA container after .storage sync
      ansible.builtin.shell: |
        sg docker -c 'docker start {{ ha_container_name }}'
      changed_when: true
      when: seedbox_found

    - name: Seedbox restore summary
      ansible.builtin.debug:
        msg:
          - "✅ .storage restored from seedbox!"
          - "Seedbox: {{ seedbox_user }}@{{ seedbox_ip }}"
          - "Path: {{ seedbox_storage_path }}"
          - "Target: {{ ha_config_dir }}/.storage/"
      when: seedbox_found

  always:
    - name: Remove seedbox private key (GUARANTEED cleanup)
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.ssh/id_ed25519_seedbox_priv"
        state: absent
      when: ansible_connection == 'local'

    - name: Remove SSH config entry (cleanup)
      ansible.builtin.lineinfile:
        path: "{{ ansible_env.HOME }}/.ssh/config"
        line: "IdentityFile {{ ansible_env.HOME }}/.ssh/id_ed25519_seedbox_priv"
        state: absent
      when: ansible_connection == 'local'
      failed_when: false
