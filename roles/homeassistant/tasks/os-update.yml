- name: Update apt cache
  become: true
  apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade packages (safe, no dist-upgrade)
  become: true
  apt:
    upgrade: yes

- name: Install unattended-upgrades (optional)
  become: true
  apt:
    name: unattended-upgrades
    state: present

# Optional: auto-remove old packages
- name: Autoremove unused packages
  become: true
  apt:
    autoremove: true

# Reboot if required (Ubuntu drops /var/run/reboot-required)
- name: Check if reboot required
  become: true
  stat:
    path: /var/run/reboot-required
  register: reboot_flag

- name: Reboot if required (bypass Ansible's local connection check)
  become: true
  ansible.builtin.shell: "sleep 2 && /sbin/reboot"
  async: 1
  poll: 0
  when: reboot_flag.stat.exists

- name: Wait for reboot to complete
  ansible.builtin.wait_for_connection:
    delay: 60
    timeout: 900
  when: reboot_flag.stat.exists