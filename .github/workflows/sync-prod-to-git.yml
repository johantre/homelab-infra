name: Sync Prod Config to Git

on:
  # Triggered by HA automation after nightly backup (event-driven, no cron)
  repository_dispatch:
    types: [prod-config-changed]
  # Manual trigger for testing or on-demand sync
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - show changes without committing'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-prod-to-git:
    runs-on: [self-hosted]
    timeout-minutes: 15

    steps:
      - name: Setup SSH key for prod access
        env:
          SSH_PRIV_KEY_B64: ${{ secrets.SSH_PRIV_KEY_B64 }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIV_KEY_B64}" | base64 -d > ~/.ssh/id_ed25519_prod
          chmod 600 ~/.ssh/id_ed25519_prod
          ssh-keyscan -H 192.168.3.8 >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "SSH key configured"

      - name: Verify SSH connectivity to prod
        run: |
          echo "Testing SSH to prod (192.168.3.8)..."
          if ! ssh -i ~/.ssh/id_ed25519_prod \
               -o ConnectTimeout=10 \
               -o StrictHostKeyChecking=no \
               -o BatchMode=yes \
               root@192.168.3.8 "echo 'SSH OK'"; then
            echo "CRITICAL: Cannot SSH to prod at 192.168.3.8"
            exit 1
          fi

      - name: Clone config repository
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
        run: |
          echo "Cloning homelab-config repository..."

          rm -rf ~/homelab/sync-config

          git clone \
            https://${GH_USERNAME}:${GH_PAT}@github.com/johantre/homelab-config.git \
            ~/homelab/sync-config

          if [[ ! -d ~/homelab/sync-config/homeassistant ]]; then
            echo "CRITICAL: homeassistant directory not found in config repo!"
            exit 1
          fi

          echo "Config repo cloned"

      - name: Sync prod config via tar-over-SSH
        run: |
          echo "Syncing prod /config/ to repo homeassistant/..."

          DEST=~/homelab/sync-config/homeassistant
          SSH_KEY=~/.ssh/id_ed25519_prod
          SSH_OPTS="-i ${SSH_KEY} -o StrictHostKeyChecking=no"

          # Clean syncable directories first (--delete equivalent for tar)
          # Only clean directories that are fully managed by prod
          # Preserve .git and other repo-only files
          for dir in custom_components blueprints packages esphome themes image; do
            if [[ -d "${DEST}/${dir}" ]]; then
              rm -rf "${DEST}/${dir}"
            fi
          done

          # Tar-over-SSH: pack on prod, extract locally
          # HAOS does not have rsync, so we use tar piped over SSH
          ssh ${SSH_OPTS} root@192.168.3.8 "tar -czf - \
            --exclude='.storage' \
            --exclude='home-assistant_v2.db*' \
            --exclude='*.db' \
            --exclude='*.db-shm' \
            --exclude='*.db-wal' \
            --exclude='*.log' \
            --exclude='*.log.*' \
            --exclude='backups' \
            --exclude='backup-auto-config' \
            --exclude='.cloud' \
            --exclude='.ha_run.lock' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='deps' \
            -C /config ." | tar -xzf - -C "${DEST}/"

          echo "Sync complete"

      - name: Detect changes
        id: detect_changes
        run: |
          cd ~/homelab/sync-config

          git add -A

          if git diff --cached --quiet; then
            echo "No changes detected between prod and git"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            echo "---"
            git diff --cached --stat
            echo "---"

            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=${CHANGED_FILES}" >> $GITHUB_OUTPUT

            git diff --cached --stat > /tmp/sync-diff-stat.txt
            git diff --cached --name-only > /tmp/sync-changed-files.txt
          fi

      - name: Commit and push changes
        if: steps.detect_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_USERNAME: ${{ secrets.GH_USERNAME }}
        run: |
          cd ~/homelab/sync-config

          git config user.name "homelab-sync-bot"
          git config user.email "homelab-sync-bot@users.noreply.github.com"

          TIMESTAMP=$(TZ='Europe/Brussels' date '+%Y-%m-%d %H:%M')
          CHANGED_COUNT=${{ steps.detect_changes.outputs.changed_files }}

          BODY=$(head -20 /tmp/sync-changed-files.txt)
          TOTAL=$(wc -l < /tmp/sync-changed-files.txt)
          if [[ ${TOTAL} -gt 20 ]]; then
            BODY="${BODY}
          ... and $((TOTAL - 20)) more"
          fi

          git commit -m "$(cat <<EOF
          sync: prod -> git (${TIMESTAMP})

          Automatic sync of ${CHANGED_COUNT} file(s) from HA prod (192.168.3.8).

          Changed files:
          ${BODY}
          EOF
          )"

          git push origin main

          echo "Committed and pushed: $(git log -1 --format='%h %s')"

      - name: Dry run summary
        if: steps.detect_changes.outputs.has_changes == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN - Changes that would be committed:"
          cat /tmp/sync-diff-stat.txt
          echo "No commit was made (dry run mode)"

      - name: Workflow summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "SYNC SUMMARY"
          echo "======================================"
          echo "Source: root@192.168.3.8:/config/"
          echo "Target: homelab-config.git (homeassistant/)"
          echo "Changes: ${{ steps.detect_changes.outputs.has_changes || 'unknown' }}"
          echo "Dry run: ${{ github.event.inputs.dry_run || 'false' }}"
          if [[ "${{ steps.detect_changes.outputs.has_changes }}" == "true" ]]; then
            echo "Files changed: ${{ steps.detect_changes.outputs.changed_files }}"
          fi
          echo "======================================"

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519_prod
